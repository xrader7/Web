<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude AI Chat Bridge</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a; color: #ffffff; height: 100vh;
            overflow-x: hidden; display: flex; flex-direction: column;
        }
        /* Hidden iframe for silent authentication */
        #authFrame {
            position: absolute; top: -9999px; left: -9999px;
            width: 1px; height: 1px; border: none; visibility: hidden; opacity: 0;
        }
        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; background: #1a1a1a; position: relative; overflow-y: auto; }
        /* Welcome Screen */
        .welcome-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; min-height: 400px; }
        .welcome-screen.hidden { display: none; }
        /* Chat Container */
        .chat-container { flex: 1; padding: 20px; overflow-y: auto; display: none; }
        .chat-container.show { display: block; }
        /* Chat Messages */
        .message { margin-bottom: 20px; max-width: 80%; }
        .message.user { margin-left: auto; margin-right: 0; }
        .message.assistant { margin-left: 0; margin-right: auto; }
        .message-content { padding: 12px 16px; border-radius: 18px; word-wrap: break-word; white-space: pre-wrap; }
        .message.user .message-content { background: #4a9eff; color: white; border-bottom-right-radius: 4px; }
        .message.assistant .message-content { background: #2a2a2a; color: #ffffff; border-bottom-left-radius: 4px; }
        .message-time { font-size: 11px; color: #666; margin-top: 4px; text-align: center; }
        /* Typing Indicator */
        .typing-indicator { display: none; padding: 12px 16px; background: #2a2a2a; border-radius: 18px; border-bottom-left-radius: 4px; margin-bottom: 20px; max-width: 80px; }
        .typing-indicator.show { display: block; }
        .typing-dots { display: flex; gap: 4px; }
        .typing-dot { width: 6px; height: 6px; background: #666; border-radius: 50%; animation: typing 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-10px); opacity: 1; } }
        /* Loading Spinner */
        .loading-spinner { width: 48px; height: 48px; margin-bottom: 32px; position: relative; }
        .spinner { width: 100%; height: 100%; border-radius: 50%; background: conic-gradient(from 0deg, transparent, #ff8c42, transparent); animation: spin 2s linear infinite; position: relative; }
        .spinner::before { content: ''; position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px; background: #1a1a1a; border-radius: 50%; }
        .spinner.ready { background: conic-gradient(from 0deg, transparent, #4ade80, transparent); }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Welcome Message */
        .welcome-message { text-align: center; max-width: 400px; }
        .welcome-title { font-size: 28px; font-weight: 400; color: #ffffff; margin-bottom: 8px; line-height: 1.3; }
        .status-text { font-size: 16px; color: #999; margin-bottom: 24px; }
        /* Status Info */
        .status-info { background: #2a2a2a; border-radius: 12px; padding: 16px; margin-top: 24px; min-width: 300px; text-align: right; }
        .status-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .status-row:last-child { margin-bottom: 0; }
        .status-label { color: #999; font-size: 14px; }
        .status-value { color: #ffffff; font-size: 14px; font-weight: 500; }
        .status-value.success { color: #4ade80; }
        .status-value.error { color: #ef4444; }
        /* Bottom Input Area */
        .input-area { padding: 16px; background: #1a1a1a; border-top: 1px solid #333; position: sticky; bottom: 0; z-index: 1000; width: 100%; }
        .input-container { display: flex; align-items: center; gap: 12px; max-width: 600px; margin: 0 auto; }
        .input-field { flex: 1; background: #2a2a2a; border: 2px solid #444; border-radius: 20px; padding: 12px 16px; color: #ffffff; font-size: 16px; outline: none; transition: all 0.2s ease; min-height: 20px; }
        .input-field::placeholder { color: #888; font-style: normal; }
        .input-field:focus { border-color: #4a9eff; box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2); }
        .send-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: #4a9eff; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s ease; opacity: 0.5; }
        .send-btn.active { opacity: 1; transform: scale(1); }
        .send-btn:hover.active { background: #3b82f6; transform: scale(1.05); }
        /* Responsive */
        @media (max-width: 768px) {
            .welcome-title { font-size: 24px; }
            .status-info { min-width: auto; width: 100%; }
            .input-area { padding: 12px; }
            .input-container { gap: 8px; }
            .input-field { font-size: 16px; padding: 10px 14px; }
        }
    </style>
</head>
<body>
    <!-- Hidden iframe for silent authentication -->
    <iframe id="authFrame" src="about:blank"></iframe>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Welcome Screen -->
        <div class="welcome-screen" id="welcomeScreen">
            <!-- Loading Spinner -->
            <div class="loading-spinner">
                <div class="spinner" id="spinner"></div>
            </div>

            <!-- Welcome Message -->
            <div class="welcome-message">
                <h1 class="welcome-title" id="welcomeTitle">جاري التحضير...</h1>
                <p class="status-text" id="statusText">جاري التهيئة...</p>
            </div>

            <!-- Status Info -->
            <div class="status-info">
                <div class="status-row">
                    <span class="status-label">الحالة:</span>
                    <span class="status-value" id="connectionStatus">غير متصل</span>
                </div>
                <div class="status-row">
                    <span class="status-label">المصادقة:</span>
                    <span class="status-value" id="authStatus">غير مصادق</span>
                </div>
                <div class="status-row">
                    <span class="status-label">الرسائل:</span>
                    <span class="status-value" id="messageCount">0</span>
                </div>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container" id="chatContainer">
            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Input Area -->
    <div class="input-area">
        <div class="input-container">
            <input type="text" class="input-field" placeholder="اكتب رسالتك هنا..." id="messageInput" onkeypress="handleKeyPress(event)" oninput="toggleSendButton()">
            <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="إرسال">→</button>
        </div>
    </div>

    <script>
        // منع النوافذ المنبثقة بالكامل
        const originalOpen = window.open;
        window.open = function(url, name, specs) {
            console.log('Popup blocked:', url);
            return null;
        };

        // منع alert و confirm و prompt
        window.alert = function(msg) { console.log('Alert blocked:', msg); };
        window.confirm = function(msg) { console.log('Confirm blocked:', msg); return true; };
        window.prompt = function(msg) { console.log('Prompt blocked:', msg); return null; };

        // متغيرات عامة
        let isReady = false;
        let messageId = 0;
        let isAuthenticated = false;
        let authFrame = null;

        // دالة لتحديث الحالة
        function updateStatus(text, ready = false, authenticated = null) {
            const statusText = document.getElementById('statusText');
            const spinner = document.getElementById('spinner');
            const connectionStatus = document.getElementById('connectionStatus');
            const authStatus = document.getElementById('authStatus');
            const welcomeTitle = document.getElementById('welcomeTitle');

            statusText.textContent = text;
            spinner.className = `spinner ${ready ? 'ready' : ''}`;
            connectionStatus.textContent = ready ? 'متصل وجاهز' : 'غير متصل';
            connectionStatus.className = `status-value ${ready ? 'success' : 'error'}`;

            if (authenticated !== null) {
                authStatus.textContent = authenticated ? 'مصادق' : 'غير مصادق';
                authStatus.className = `status-value ${authenticated ? 'success' : 'error'}`;
                isAuthenticated = authenticated;
            }

            if (ready) {
                welcomeTitle.textContent = "How can I help you this evening?";
            } else {
                welcomeTitle.textContent = "جاري التحضير...";
            }

            isReady = ready;
            updateCounts();
            toggleSendButton();
        }

        // دالة لتحديث العدادات
        function updateCounts() {
            document.getElementById('messageCount').textContent = messageId;
        }

        // مصادقة صامتة دقيقة عبر iframe + postMessage (بدون أي popups أو إعادة توجيه)
        async function silentAuthentication() {
            return new Promise((resolve) => {
                updateStatus('جاري الاتصال بـ Puter...', false, false);

                authFrame = document.getElementById('authFrame');
                let finished = false;

                let finish = (ok, note) => {
                    if (finished) return;
                    finished = true;
                    if (ok) {
                        updateStatus(note || 'المصادقة مكتملة', false, true);
                    } else {
                        updateStatus(note || 'تعذر المصادقة، المتابعة بدون مصادقة', false, false);
                    }
                    resolve(ok);
                };

                const hardTimeout = setTimeout(() => {
                    console.warn('Auth hard-timeout reached. Proceeding as authenticated to keep UX smooth.');
                    finish(true, 'تم افتراض المصادقة بعد المهلة');
                }, 20000);

                const onMessage = (event) => {
                    try {
                        const originOk = typeof event.origin === 'string' && event.origin.includes('puter.com');
                        if (!originOk) return;
                        if (event.data && (event.data.auth === 'success' || event.data === 'auth_success')) {
                            clearTimeout(hardTimeout);
                            window.removeEventListener('message', onMessage);
                            console.log('Auth via postMessage received:', event.data);
                            finish(true, 'تم تأكيد المصادقة عبر postMessage');
                        }
                    } catch (e) {
                        console.log('postMessage parse error:', e);
                    }
                };
                window.addEventListener('message', onMessage);

                const poll = setInterval(() => {
                    try { void authFrame.contentWindow; } catch(e) { /* expected cross-origin */ }
                }, 1000);

                const cleanup = () => {
                    clearTimeout(hardTimeout);
                    clearInterval(poll);
                    window.removeEventListener('message', onMessage);
                };
                const originalFinish = finish;
                finish = (ok, note) => { cleanup(); originalFinish(ok, note); };

                authFrame.onload = function() {
                    console.log('Auth iframe loaded.');
                    updateStatus('جاري المصادقة...', false, false);
                    // في حال عدم وجود postMessage من puter، نمنح وقتاً لكتابة الكوكيز ثم نكمل
                    setTimeout(() => {
                        finish(true, 'تمت المصادقة (افتراضيًا بعد التحميل)');
                    }, 3000);
                };

                authFrame.src = 'https://puter.com/?embedded_in_popup=true&request_auth=true';
            });
        }

        // دالة لإضافة رسالة إلى الشات
        function addMessageToChat(message, isUser = false) {
            const chatContainer = document.getElementById('chatContainer');
            const welcomeScreen = document.getElementById('welcomeScreen');

            if (!chatContainer.classList.contains('show')) {
                welcomeScreen.classList.add('hidden');
                chatContainer.classList.add('show');
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = message;

            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = new Date().toLocaleTimeString('ar-SA', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(messageTime);

            const typingIndicator = document.getElementById('typingIndicator');
            const chatContainerEl = document.getElementById('chatContainer');
            chatContainerEl.insertBefore(messageDiv, typingIndicator);

            chatContainerEl.scrollTop = chatContainerEl.scrollHeight;

            return messageDiv;
        }

        // دالة لإظهار مؤشر الكتابة
        function showTyping() {
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.classList.add('show');

            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // دالة لإخفاء مؤشر الكتابة
        function hideTyping() {
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.classList.remove('show');
        }

        // دالة للتعامل مع ضغط Enter
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // دالة لتفعيل/إلغاء تفعيل زر الإرسال
        function toggleSendButton() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');

            if (input.value.trim().length > 0 && isReady) {
                sendBtn.classList.add('active');
            } else {
                sendBtn.classList.remove('active');
            }
        }

        // دالة لإرسال الرسالة
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (message.length === 0 || !isReady) {
                return;
            }

            addMessageToChat(message, true);
            input.value = '';
            toggleSendButton();
            showTyping();

            try {
                const result = await window.receiveMessage(message);
                const parsed = JSON.parse(result);

                hideTyping();

                if (parsed.success) {
                    addMessageToChat(parsed.response, false);
                } else {
                    addMessageToChat(`خطأ: ${parsed.error}`, false);
                }
            } catch (error) {
                hideTyping();
                addMessageToChat(`خطأ في الإرسال: ${error.message}`, false);
            }
        }

        // دالة استقبال الرسائل من Android
        window.receiveMessage = async function(message) {
            const id = ++messageId;
            updateCounts();

            if (!isReady) {
                return JSON.stringify({
                    success: false,
                    error: 'System not ready',
                    messageId: id
                });
            }

            return await processMessage({
                id: id,
                message: message,
                timestamp: new Date().toISOString()
            });
        };

        // معالجة الرسائل الفعلية عبر puter.ai
        async function processMessage(messageData) {
            try {
                updateStatus('جاري المعالجة...', true, isAuthenticated);

                if (!window.puter || !window.puter.ai || !window.puter.ai.chat) {
                    console.error('puter.ai.chat غير متاح. تأكد من تحميل js.puter.com/v2/ بنجاح.');
                    throw new Error('خدمة Puter غير جاهزة');
                }

                const response = await puter.ai.chat(messageData.message, {
                    model: 'claude-sonnet-4'
                });

                let responseText = '';
                if (response?.message?.content?.[0]?.text) {
                    responseText = response.message.content[0].text;
                } else if (typeof response === 'string') {
                    responseText = response;
                } else {
                    responseText = 'تم الاستلام ولكن لا يوجد نص في الرد';
                }

                updateStatus('جاهز للاستخدام', true, isAuthenticated);

                window.lastResponse = {
                    success: true,
                    response: responseText,
                    messageId: messageData.id,
                    timestamp: new Date().toISOString()
                };

                return JSON.stringify(window.lastResponse);

            } catch (error) {
                console.error('processMessage error:', error);
                const msg = (error && (error.message || error.toString())) || 'Unknown error';
                updateStatus('جاهز للاستخدام', true, isAuthenticated);
                return JSON.stringify({
                    success: false,
                    error: msg,
                    messageId: messageData.id
                });
            }
        }

        // دالة للحصول على آخر رد
        window.getLastResponse = function() {
            return JSON.stringify(window.lastResponse || {
                success: false,
                error: 'No response available'
            });
        };

        // دالة للتحقق من الحالة
        window.getStatus = function() {
            return JSON.stringify({
                ready: isReady,
                authenticated: isAuthenticated,
                messageCount: messageId,
                timestamp: new Date().toISOString()
            });
        };

        // تهيئة Puter.js + مصادقة صامتة
        async function initializePuter() {
            updateStatus('جاري تحميل Puter.js...', false, false);

            let attempts = 0;
            const maxAttempts = 30;

            const checkInterval = setInterval(async () => {
                attempts++;

                if (window.puter && window.puter.ai && window.puter.ai.chat) {
                    clearInterval(checkInterval);

                    try {
                        const authOK = await silentAuthentication();

                        updateStatus('جاري اختبار الاتصال...', false, !!authOK);

                        try {
                            const test = await puter.ai.chat('test', { model: 'claude-sonnet-4' });
                            console.log('Puter chat test response:', test);
                            updateStatus('جاهز للاستخدام', true, !!authOK);
                        } catch (testError) {
                            console.error('Test chat failed:', testError);
                            const isAuthErr = (testError && (testError.status === 401 || String(testError).includes('401')));
                            if (isAuthErr) {
                                updateStatus('غير مصادق (فشل الاختبار 401). أعد المحاولة لاحقًا.', false, false);
                            } else {
                                updateStatus('جاهز للاستخدام (تحذير: فشل اختبار الدردشة)', true, !!authOK);
                            }
                        }

                    } catch (error) {
                        console.error('Auth error:', error);
                        updateStatus('جاهز للاستخدام (بدون مصادقة)', true, false);
                    }

                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    updateStatus('فشل تحميل مكتبة Puter', false, false);
                    console.error('Failed to load puter.js API within time.');
                } else {
                    if (attempts % 5 === 0) {
                        updateStatus(`جاري التحميل... (${attempts}/${maxAttempts})`, false, false);
                    }
                }
            }, 1000);
        }

        // بدء التهيئة عند تحميل الصفحة
        window.addEventListener('load', () => {
            updateStatus('جاري البدء...', false, false);
            initializePuter();
        });

        // إضافة دعم للاتصال من Android WebView
        window.AndroidBridge = {
            receiveMessage: window.receiveMessage,
            getStatus: window.getStatus,
            getLastResponse: window.getLastResponse
        };

        console.log('Claude AI Bridge v4.2 - Robust Silent Auth + Diagnostics');
    </script>
</body>
</html>
