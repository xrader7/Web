<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التسجيل بالكود</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
        }
        .login-form, .main-page {
            text-align: center;
        }
        .main-page { display: none; }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover { background: #5a67d8; }
        .error { color: red; margin: 10px 0; }
        .success { color: green; margin: 10px 0; }
        #status { margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <!-- صفحة تسجيل الدخول -->
        <div class="login-form" id="loginForm">
            <h2>تسجيل الدخول</h2>
            <input type="text" id="codeInput" placeholder="أدخل الكود" maxlength="18">
            <button onclick="login()">تسجيل الدخول</button>
            <div id="status"></div>
        </div>

        <!-- الصفحة الرئيسية -->
        <div class="main-page" id="mainPage">
            <h2>مرحباً بك في الصفحة الرئيسية</h2>
            <p>تم تسجيل الدخول بنجاح!</p>
            <p>كودك: <span id="userCode"></span></p>
            <button onclick="logout()">تسجيل الخروج</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // إعداد Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com/",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // الحصول على بصمة الجهاز
        function getDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Device fingerprint', 2, 2);
            
            return btoa(JSON.stringify({
                screen: screen.width + 'x' + screen.height,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                platform: navigator.platform,
                canvas: canvas.toDataURL(),
                userAgent: navigator.userAgent.slice(0, 50)
            }));
        }

        const deviceId = getDeviceFingerprint();

        // التحقق من حالة تسجيل الدخول عند تحميل الصفحة
        window.onload = function() {
            const savedCode = localStorage.getItem('userCode');
            const savedDevice = localStorage.getItem('deviceId');
            
            if (savedCode && savedDevice === deviceId) {
                verifySession(savedCode);
            }
        }

        // التحقق من الجلسة
        function verifySession(code) {
            // التحقق من القائمة السوداء أولاً
            database.ref('blacklist/' + btoa(deviceId)).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    showError('جهازك محظور من استخدام الموقع');
                    localStorage.clear();
                    return;
                }
                
                // التحقق من الكود والجهاز
                database.ref('codes/' + code).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        const codeData = snapshot.val();
                        if (codeData.used && codeData.deviceId === deviceId) {
                            showMainPage(code);
                        } else if (codeData.used && codeData.deviceId !== deviceId) {
                            // إضافة الجهاز للقائمة السوداء
                            database.ref('blacklist/' + btoa(deviceId)).set({
                                deviceId: deviceId,
                                timestamp: Date.now(),
                                reason: 'محاولة استخدام كود مستخدم مسبقاً'
                            });
                            showError('تم حظر جهازك لمحاولة استخدام كود مستخدم مسبقاً');
                            localStorage.clear();
                        } else {
                            localStorage.clear();
                            showError('يرجى تسجيل الدخول مرة أخرى');
                        }
                    } else {
                        localStorage.clear();
                        showError('كود غير صالح');
                    }
                });
            });
        }

        // تسجيل الدخول
        function login() {
            const code = document.getElementById('codeInput').value.trim();
            
            if (code.length !== 18) {
                showError('الكود يجب أن يكون 18 حرف بالضبط');
                return;
            }

            // التحقق من القائمة السوداء أولاً
            database.ref('blacklist/' + btoa(deviceId)).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    showError('جهازك محظور من استخدام الموقع');
                    return;
                }

                // التحقق من وجود الكود
                database.ref('codes/' + code).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        const codeData = snapshot.val();
                        
                        if (codeData.used) {
                            if (codeData.deviceId === deviceId) {
                                // نفس الجهاز
                                showMainPage(code);
                                localStorage.setItem('userCode', code);
                                localStorage.setItem('deviceId', deviceId);
                            } else {
                                // جهاز مختلف - إضافة للقائمة السوداء
                                database.ref('blacklist/' + btoa(deviceId)).set({
                                    deviceId: deviceId,
                                    timestamp: Date.now(),
                                    reason: 'محاولة استخدام كود مستخدم مسبقاً'
                                });
                                showError('هذا الكود مستخدم مسبقاً على جهاز آخر. تم حظر جهازك.');
                            }
                        } else {
                            // كود جديد - تفعيله
                            database.ref('codes/' + code).update({
                                used: true,
                                deviceId: deviceId,
                                usedAt: Date.now()
                            }).then(() => {
                                showMainPage(code);
                                localStorage.setItem('userCode', code);
                                localStorage.setItem('deviceId', deviceId);
                            });
                        }
                    } else {
                        showError('كود غير صحيح');
                    }
                }).catch((error) => {
                    showError('خطأ في الاتصال: ' + error.message);
                });
            });
        }

        // عرض الصفحة الرئيسية
        function showMainPage(code) {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('mainPage').style.display = 'block';
            document.getElementById('userCode').textContent = code;
            
            // التحقق المستمر من الجلسة
            setInterval(() => verifySession(code), 30000); // كل 30 ثانية
        }

        // تسجيل الخروج
        function logout() {
            localStorage.clear();
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('codeInput').value = '';
            document.getElementById('status').innerHTML = '';
        }

        // عرض رسائل الخطأ
        function showError(message) {
            document.getElementById('status').innerHTML = '<div class="error">' + message + '</div>';
        }

        // عرض رسائل النجاح
        function showSuccess(message) {
            document.getElementById('status').innerHTML = '<div class="success">' + message + '</div>';
        }
    </script>
</body>
</html>
